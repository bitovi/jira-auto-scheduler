{"version":3,"file":"update-epics-IPC3n2Z4.js","sources":["../update-epics.js"],"sourcesContent":["import { StacheElement, type, ObservableObject, fromAttribute, stache } from \"./can.js\";\nimport {getDatesFromWork} from \"./simulation-data.js\";\n\nconst jiraDataFormatter = new Intl.DateTimeFormat('en-CA', { // 'en-CA' uses the YYYY-MM-DD format\n    year: 'numeric',\n    month: '2-digit', // '2-digit' will ensure month is always represented with two digits\n    day: '2-digit', // '2-digit' will ensure day is always represented with two digits\n    calendar: 'iso8601', // This specifies usage of the ISO 8601 calendar\n    timeZone: \"UTC\"\n  });\n\nclass UpdateEpics extends StacheElement {\n    static view = `\n        <form class=\"p-4 rounded\">\n            <h3 class=\"text-lg font-semibold\">Review changes</h3>\n            <div \n                class=\"grid gap-x-3 py-4\"\n                style=\"grid-template-columns: repeat(9, auto); \">\n                <div style=\"grid-row: 1; grid-column: 1 / span 3\" class=\"text-sm\"></div>\n                <div style=\"grid-row: 1; grid-column: 4 / span 2\" class=\"text-sm text-center\">Story Points</div>\n                <div style=\"grid-row: 1; grid-column: 6 / span 2\" class=\"text-sm text-center\">Start Date</div>\n                <div style=\"grid-row: 1; grid-column: 8 / span 2\" class=\"text-sm text-center\">Due Date</div>\n                <div style=\"grid-row: 2; grid-column: 1\" class=\"text-sm\">\n                    <input type=\"checkbox\"  \n                        on:change=\"this.selectAll(scope.element.checked)\"\n                        checked:from=\"this.allWorkItemsSelected()\"/>\n                </div>\n                <div style=\"grid-row: 2; grid-column: 2\" class=\"text-sm\">Key</div>\n                <div style=\"grid-row: 2; grid-column: 3\" class=\"text-sm\">Summary</div>\n                <div style=\"grid-row: 2; grid-column: 4\" class=\"text-sm pl-2\">Current</div>\n                <div style=\"grid-row: 2; grid-column: 5\" class=\"text-sm pr-2\">New</div>\n                <div style=\"grid-row: 2; grid-column: 6\" class=\"text-sm pl-2\">Current</div>\n                <div style=\"grid-row: 2; grid-column: 7\" class=\"text-sm pr-2\">New</div>\n                <div style=\"grid-row: 2; grid-column: 8\" class=\"text-sm pl-2\">Current</div>\n                <div style=\"grid-row: 2; grid-column: 9\" class=\"text-sm\">New</div>\n                <div \n                    class=\"border-solid border-b border-neutral-40\"\n                    style=\"grid-row: 2 / span 1; grid-column: 1 / span 9; z-index: -1\"></div>\n                {{# for(workItem of this.workItemsWithDates) }}\n                    <div>\n                        <input type=\"checkbox\" \n                            on:change=\"this.selectWorkItem(workItem, scope.element.checked)\"\n                            checked:from=\"this.isWorkItemSelected(workItem)\"/>\n                    </div>\n                    <div>{{workItem.work.issue[\"Issue key\"]}}</div>\n                    <div>{{workItem.work.issue.Summary}}</div>\n                    <div class=\"pl-2 text-right\">{{ this.oldStoryPoints(workItem) }}</div>\n                    <div class=\"pr-2 {{this.storyPointsEqualClassName(workItem)}} text-right\">{{ this.newStoryPoints(workItem) }}</div>\n                    <div class=\"pl-2\">{{workItem.work.issue[this.startDateField]}}</div>\n                    <div class=\"pr-2 {{this.startDateEqualClassName(workItem)}}\">{{ jiraDates( workItem.dates.startDate ) }}</div>\n                    <div class=\"pl-2\">{{workItem.work.issue[this.dueDateField]}}</div>\n                    <div class=\" {{this.dueDateEqualClassName(workItem)}}\">{{ jiraDates( workItem.dates.dueDate ) }}</div>\n                {{/ for }}\n            </div>\n            <div class=\"flex gap-2 flex-row-reverse\">\n                {{# if(this.issueUpdates.isPending) }}\n                    <button class=\"btn-primary\" disabled>\n                    <svg class=\"animate-spin -ml-0.5 -mt-0.5 mr-1 h-e w-4 text-white inline-block\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                        <circle class=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"4\"></circle>\n                        <path class=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                    </svg> \n                    Saving changes in Jira\n                    \n                    </button>\n                {{/ if }}\n                {{# or(this.issueUpdates.isResolved, not(this.issueUpdates)) }}\n                    <button class=\"btn-primary\" on:click=\"this.save(scope.event)\" disabled:from=\"not(this.selectedWorkItemsToBeSaved.length)\">\n                        Save selected changes in Jira\n                    </button>\n                {{/ or }}\n                \n                <button class=\"btn-secondary\" value=\"cancel\" formmethod=\"dialog\">Cancel</button>\n            </div>\n            {{# eq(this.issueUpdateOutcome.status, \"rejected\") }}\n            <div class=\"bg-yellow-500 p-4 mt-2\">\n                <p class=\"text-lg\">There was an error saving to Jira!</p>\n                <p>Error: {{this.issueUpdateOutcome.errorReasons[0]}}</p>\n            </div>\n            {{/ eq }}\n        </form>\n    `;\n    static props = {\n        workItems: type.Any,\n        selectedWorkItems: {\n            value({listenTo, resolve, lastSet}){\n                listenTo(lastSet, (value)=>{\n                    resolve(value);\n                })\n                listenTo(\"workItems\",()=>{\n                    resolve(new Set())\n                });\n                resolve(new Set());\n            }\n        },\n        storyPointField: String,\n        startDateField: String,\n        dueDateField: String,\n        startDate: Date,\n        issueUpdates: type.Any,\n        jiraHelpers: type.Any,\n\n        // {status: waiting|pending|rejected|fulfilled, errorReasons: []}\n        issueUpdateOutcome: {\n            value({listenTo, resolve}){\n                const updateFromPromise =  (updatePromises) => {\n                    if(!updatePromises) {\n                        resolve({errorReasons: [], status: \"waiting\"})\n                    } else {\n                        resolve({errorReasons: [], status: \"pending\"})\n                        updatePromises.then((outcomes)=>{\n                            const errors = outcomes.map((outcome, index) => {\n                                return {...outcome, workItem: this.selectedWorkItemsToBeSaved[index]}\n                            }).filter( outcome => outcome.status === \"rejected\");\n                            debugger;\n                            if(errors.length) {\n                                console.log(this.selectedWorkItemsToBeSaved);\n                                return resolve({\n                                    errorReasons: getNiceReasonsMessages( errors.map(({reason, workItem}) => {\n                                        return {reason, workItem}\n                                    }), this.jiraFields ), \n                                    status: \"rejected\"\n                                })\n                            } else {\n                                return resolve({errorReasons: [], status: \"fulfilled\"})\n                            }\n                        });\n                    }\n                }\n                listenTo(\"issueUpdates\",({value})=>{\n                    updateFromPromise(value)\n                });\n                updateFromPromise(this.updatePromises);\n            }\n        }\n    };\n    connected(){\n        // this isn't great, but easy\n        this.parentElement.showModal();\n        this.listenTo(\"issueUpdateOutcome\",({value})=>{\n            if(value.status === \"fulfilled\") {\n                this.issueUpdates = null;\n                this.dispatch(\"saved\");\n            }\n        })\n        this.jiraHelpers.fieldsRequest.then((fields)=>{\n            this.jiraFields = fields;\n        })\n    }\n    selectAll(checked){\n        this.selectedWorkItems = checked ? new Set( this.workItemsWithDates.map((workItem)=> {\n            return workItem.work.issue[\"Issue key\"];\n        }) ) : new Set()\n    }\n    allWorkItemsSelected(){\n        const selected = this.workItemsWithDates.map( (workItem)=> {\n            return workItem.work.issue[\"Issue key\"];\n        })\n        return selected.every( (key)=> {\n            return this.selectedWorkItems.has( key )\n        })\n    }\n    isWorkItemSelected(workItem){\n        return this.selectedWorkItems.has( workItem.work.issue[\"Issue key\"] )\n    }\n    selectWorkItem(workItem, checked){\n        const key = workItem.work.issue[\"Issue key\"];\n        const newItems = new Set(this.selectedWorkItems);\n        if(checked) {\n            newItems.add(key)\n        } else {\n            newItems.delete(key)\n        }\n        this.selectedWorkItems = newItems;\n    }\n    get workItemsWithDates(){\n        return Object.values(this.workItems).map( (workItem)=> {\n            const clone = workItem.serialize();\n            clone.dates = getDatesFromWork(clone, this.startDate);\n            return clone;\n        }) \n    }\n    get selectedWorkItemsToBeSaved(){\n        return this.workItemsWithDates.filter( (workItem)=> {\n            return this.selectedWorkItems.has( workItem.work.issue[\"Issue key\"] )\n        });\n    }\n    jiraDates(date){\n        return jiraDataFormatter.format(date)\n    }\n    round(number) {\n        return Math.round(number)\n    }\n    oldStoryPoints(workItem) {\n        return workItem.work.issue[this.storyPointField];\n    }\n    newStoryPoints(workItem) {\n        return Math.round( workItem.dates.totalPoints );\n    }\n    storyPointsEqualClassName(workItem) {\n        return this.oldStoryPoints(workItem) !== this.newStoryPoints(workItem) ? \"bg-yellow-300\" : \"\";\n    }\n    startDateEqualClassName(workItem) {\n        return workItem.work.issue[this.startDateField] !== this.jiraDates( workItem.dates.startDate ) ? \"bg-yellow-300\" : \"\";\n    }\n    dueDateEqualClassName(workItem) {\n        return workItem.work.issue[this.dueDateField] !== this.jiraDates( workItem.dates.dueDate ) ? \"bg-yellow-300\" : \"\";\n    }\n    save(event){\n        event.preventDefault();\n        const allWork = this.selectedWorkItemsToBeSaved.map( workItem => {\n          return {\n            ...workItem,\n            updates: {\n              [this.startDateField]: this.jiraDates( workItem.dates.startDateWithTimeEnoughToFinish ),\n              [this.dueDateField]: this.jiraDates( workItem.dates.dueDate ),\n              [this.storyPointField]: this.newStoryPoints(workItem)\n            }\n          };\n        });\n  \n      const changedWork = allWork/*.filter((work) => {\n        return work.issue[\"Start date\"] !== work.updates[\"Start date\"]  \n          || work.issue[\"Due date\"] !== work.updates[\"Due date\"] \n          || work.issue[\"Story points\"] !== work.updates[\"Story points\"];\n      });*/\n      const updates = changedWork.map( workItem => {\n        return {\n            ...workItem,\n            updatePromise: this.jiraHelpers.editJiraIssueWithNamedFields(workItem.work.issue[\"Issue key\"], workItem.updates)\n        }\n      })\n      this.issueUpdates = Promise.allSettled(updates.map( update => update.updatePromise));\n\n    }\n}\n\nfunction getNiceReasonsMessages(reasons, jiraFields){\n    return reasons.map(reason => getNiceReasonsMessage(reason, jiraFields));\n}\n\nfunction getNiceReasonsMessage({reason, workItem}, jiraFields){\n    if(Array.isArray( reason.errorMessages) && reason.errorMessages.length) {\n        return reason.errorMessages[0]\n    } else if(reason.errors ) {\n        console.log(reason.errors);\n        const message = Object.values(reason.errors)[0];\n        if(message.includes(\"It is not on the appropriate screen, or unknown\")) {\n            const missingKeys = Object.keys(reason.errors);\n            const missingKeyNames = missingKeys.map( key => jiraFields.idMap[key] || key);\n            \n            return stache.safeString(`The fields (${missingKeyNames.join(\", \")}) are not on the screen associated with the\n                <a target='_blank' href='${workItem.work.issue.url}'>${workItem.work.issue.Summary}</a> epic.`+\n                \" <a target='_blank' href='https://github.com/bitovi/jira-auto-scheduler/wiki/Troubleshooting#a-field-is-not-on-the-appropriate-screen'>Read how to fix it here.</a>\")\n        } else {\n            return message;\n        }\n         \n    } else {\n        return reason.message;\n    }\n}\n\n\nexport default UpdateEpics;\n\ncustomElements.define(\"update-epics\", UpdateEpics);"],"names":["jiraDataFormatter","Intl","DateTimeFormat","year","month","day","calendar","timeZone","UpdateEpics","StacheElement","static","workItems","type","Any","selectedWorkItems","value","listenTo","resolve","lastSet","Set","storyPointField","String","startDateField","dueDateField","startDate","Date","issueUpdates","jiraHelpers","issueUpdateOutcome","updateFromPromise","updatePromises","errorReasons","status","then","outcomes","errors","map","outcome","index","workItem","this","selectedWorkItemsToBeSaved","filter","length","console","log","reasons","reason","jiraFields","Array","isArray","errorMessages","message","Object","values","includes","missingKeyNames","keys","key","idMap","stache","safeString","join","work","issue","url","Summary","getNiceReasonsMessage","connected","parentElement","showModal","dispatch","fieldsRequest","fields","selectAll","checked","workItemsWithDates","allWorkItemsSelected","every","has","isWorkItemSelected","selectWorkItem","newItems","add","delete","clone","serialize","dates","getDatesFromWork","jiraDates","date","format","round","number","Math","oldStoryPoints","newStoryPoints","totalPoints","storyPointsEqualClassName","startDateEqualClassName","dueDateEqualClassName","dueDate","save","event","preventDefault","updates","startDateWithTimeEnoughToFinish","updatePromise","editJiraIssueWithNamedFields","Promise","allSettled","update","customElements","define"],"mappings":"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"}